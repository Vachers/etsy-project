// ========================================
// PROJEKTİF PRO - Prisma Schema
// Enterprise Digital Project & Sales Tracking
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Authentication Models (NextAuth.js)
// ========================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// User Model
// ========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  password      String?
  image         String?
  role          UserRole  @default(USER)

  // Relations
  accounts            Account[]
  sessions            Session[]
  projects            Project[]
  sales               Sale[]
  tasks               Task[]               @relation("AssignedTasks")
  activities          Activity[]
  digitalProducts     DigitalProduct[]
  projectMemberships  ProjectMember[]      @relation("ProjectMembers")
  projectActivityLogs ProjectActivityLog[] @relation("ProjectActivityLogs")
  sentMessages        ProjectMessage[]     @relation("SentMessages")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

// ========================================
// Category Model
// ========================================

model Category {
  id          String  @id @default(cuid())
  name        String
  description String?
  color       String  @default("#2563eb")
  icon        String?

  // Relations
  projects Project[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("categories")
}

// ========================================
// Project Model
// ========================================

model Project {
  id          String        @id @default(cuid())
  title       String
  description String?       @db.Text
  status      ProjectStatus @default(DRAFT)
  priority    Priority      @default(MEDIUM)
  budget      Decimal?      @db.Decimal(12, 2)
  spent       Decimal?      @db.Decimal(12, 2) @default(0)
  progress    Int           @default(0)
  startDate   DateTime?     @map("start_date")
  endDate     DateTime?     @map("end_date")

  // Relations
  categoryId   String?              @map("category_id")
  category     Category?            @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  userId       String               @map("user_id")
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks        Task[]
  sales        Sale[]
  members      ProjectMember[]
  activityLogs ProjectActivityLog[]
  messages     ProjectMessage[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([categoryId])
  @@index([status])
  @@map("projects")
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ========================================
// Task Model
// ========================================

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  dueDate     DateTime?  @map("due_date")
  completedAt DateTime?  @map("completed_at")
  order       Int        @default(0)

  // Relations
  projectId  String  @map("project_id")
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assigneeId String? @map("assignee_id")
  assignee   User?   @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
}

// ========================================
// Sale Model
// ========================================

model Sale {
  id            String     @id @default(cuid())
  title         String
  description   String?    @db.Text
  amount        Decimal    @db.Decimal(12, 2)
  currency      String     @default("TRY")
  platform      Platform   @default(OTHER)
  status        SaleStatus @default(PENDING)
  orderId       String?    @map("order_id")
  customerName  String?    @map("customer_name")
  customerEmail String?    @map("customer_email")
  saleDate      DateTime   @default(now()) @map("sale_date")
  notes         String?    @db.Text

  // Relations
  projectId String?  @map("project_id")
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([projectId])
  @@index([platform])
  @@index([status])
  @@index([saleDate])
  @@map("sales")
}

enum Platform {
  ETSY
  AMAZON
  SHOPIFY
  EBAY
  WEBSITE
  OTHER
}

enum SaleStatus {
  PENDING
  COMPLETED
  REFUNDED
  CANCELLED
}

// ========================================
// Activity Model (Audit Log)
// ========================================

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  action      String
  entityType  String       @map("entity_type")
  entityId    String       @map("entity_id")
  title       String
  description String?
  metadata    Json?

  // Relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activities")
}

enum ActivityType {
  PROJECT
  SALE
  TASK
  USER
  SYSTEM
}

// ========================================
// Settings Model
// ========================================

model Settings {
  id        String @id @default(cuid())
  key       String @unique
  value     Json
  category  String @default("general")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ========================================
// Sales Platform Model (Dynamic Platforms)
// ========================================

model SalesPlatform {
  id              String   @id @default(cuid())
  name            String   @unique
  slug            String   @unique
  logo            String?
  websiteUrl      String?  @map("website_url")
  commissionRate  Decimal  @db.Decimal(5, 2) @default(0) @map("commission_rate")
  defaultCurrency String   @default("USD") @map("default_currency")
  color           String   @default("#2563eb")
  isActive        Boolean  @default(true) @map("is_active")
  description     String?

  // Relations
  listings      ProductPlatformListing[]
  salesAccounts SalesAccount[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sales_platforms")
}

// ========================================
// Sales Account Model (Platform Shops/Accounts)
// ========================================

model SalesAccount {
  id          String  @id @default(cuid())
  name        String  // "Ana Etsy Dükkanım", "Gumroad Pro Account"
  shopName    String? @map("shop_name")
  shopUrl     String? @map("shop_url")
  username    String?
  email       String?
  isActive    Boolean @default(true) @map("is_active")
  isDefault   Boolean @default(false) @map("is_default")
  notes       String? @db.Text
  metadata    Json?

  // Relations
  platformId String        @map("platform_id")
  platform   SalesPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  listings   ProductPlatformListing[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([platformId])
  @@map("sales_accounts")
}

// ========================================
// Digital Product Model
// ========================================

model DigitalProduct {
  id          String          @id @default(cuid())
  title       String
  description String?         @db.Text
  thumbnail   String?
  category    ProductCategory
  status      ProductStatus   @default(DRAFT)
  downloadUrl String?         @map("download_url")
  fileSize    String?         @map("file_size")
  metadata    Json?
  tags        String[]        @default([])

  // Relations
  userId   String                   @map("user_id")
  user     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listings ProductPlatformListing[]
  prompts  ProductPrompt[]
  pictures ProductPicture[]
  mockups  ProductMockup[]
  files    ProductFile[]
  preSale  ProductPreSale?
  saleInfo ProductSaleInfo?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([category])
  @@index([status])
  @@map("digital_products")
}

// ========================================
// Product Platform Listing (Many-to-Many)
// ========================================

model ProductPlatformListing {
  id                String        @id @default(cuid())
  price             Decimal       @db.Decimal(12, 2)
  currency          String        @default("TRY")
  productUrl        String?       @map("product_url")
  platformProductId String?       @map("platform_product_id")
  status            ListingStatus @default(DRAFT)
  listedAt          DateTime?     @map("listed_at")
  notes             String?       @db.Text

  // Relations
  productId      String          @map("product_id")
  product        DigitalProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)
  platformId     String          @map("platform_id")
  platform       SalesPlatform   @relation(fields: [platformId], references: [id], onDelete: Cascade)
  salesAccountId String?         @map("sales_account_id")
  salesAccount   SalesAccount?   @relation(fields: [salesAccountId], references: [id], onDelete: SetNull)

  // Sales Records
  salesRecords SalesRecord[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, platformId])
  @@index([productId])
  @@index([platformId])
  @@index([salesAccountId])
  @@index([status])
  @@map("product_platform_listings")
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SELLING
  PAUSED
  ARCHIVED
}

// ========================================
// Sales Record Model (Periodic Sales Data)
// ========================================

model SalesRecord {
  id               String   @id @default(cuid())
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  quantity         Int      @default(0)
  grossRevenue     Decimal  @db.Decimal(12, 2) @map("gross_revenue")
  commissionAmount Decimal  @db.Decimal(12, 2) @default(0) @map("commission_amount")
  netRevenue       Decimal  @db.Decimal(12, 2) @map("net_revenue")
  currency         String   @default("TRY")
  notes            String?  @db.Text

  // Relations
  listingId String                 @map("listing_id")
  listing   ProductPlatformListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([listingId])
  @@index([periodStart, periodEnd])
  @@map("sales_records")
}

enum ProductCategory {
  EBOOKS
  DIGITAL_PRODUCTS
  DIGITAL_BUNDLES
  SOCIAL_MEDIA
  DETECTIVE_PROJECTS
  MUSIC_PROJECTS
  GAME_SELL
}

enum ProductStatus {
  DRAFT
  ACTIVE
  SELLING
  ARCHIVED
}

// ========================================
// Project Member Model (User-Project Relation)
// ========================================

model ProjectMember {
  id        String     @id @default(cuid())
  role      MemberRole @default(MEMBER)

  // Relations
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String  @map("user_id")
  user      User    @relation("ProjectMembers", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

enum MemberRole {
  ADMIN
  MEMBER
  VIEWER
}

// ========================================
// Project Activity Log Model
// ========================================

model ProjectActivityLog {
  id          String         @id @default(cuid())
  action      ProjectAction
  description String
  metadata    Json?
  
  // Relations
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String  @map("user_id")
  user      User    @relation("ProjectActivityLogs", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
  @@map("project_activity_logs")
}

enum ProjectAction {
  CREATED
  UPDATED
  STATUS_CHANGED
  MEMBER_ADDED
  MEMBER_REMOVED
  TASK_ADDED
  TASK_COMPLETED
  FILE_UPLOADED
  COMMENT_ADDED
  SETTINGS_CHANGED
}

// ========================================
// Project Message Model (Real-time Chat)
// ========================================

model ProjectMessage {
  id        String  @id @default(cuid())
  content   String  @db.Text
  isRead    Boolean @default(false) @map("is_read")
  
  // Relations
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  senderId  String  @map("sender_id")
  sender    User    @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([senderId])
  @@index([createdAt])
  @@map("project_messages")
}

// ========================================
// Product Prompt Model (AI Prompts)
// ========================================

model ProductPrompt {
  id       String         @id @default(cuid())
  title    String
  content  String         @db.Text
  category PromptCategory @default(IMAGE)
  notes    String?        @db.Text
  order    Int            @default(0)

  // Relations
  productId String         @map("product_id")
  product   DigitalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  pictures  ProductPicture[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@map("product_prompts")
}

enum PromptCategory {
  IMAGE
  TEXT
  VIDEO
  AUDIO
  OTHER
}

// ========================================
// Product Picture Model (Generated Images)
// ========================================

model ProductPicture {
  id           String     @id @default(cuid())
  title        String?
  imageUrl     String     @map("image_url")
  aiPlatform   AIPlatform @map("ai_platform")
  modelVersion String?    @map("model_version")
  notes        String?    @db.Text
  order        Int        @default(0)

  // Relations
  productId String          @map("product_id")
  product   DigitalProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)
  promptId  String?         @map("prompt_id")
  prompt    ProductPrompt?  @relation(fields: [promptId], references: [id], onDelete: SetNull)
  files     ProductFile[]   @relation("PictureFiles")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([promptId])
  @@map("product_pictures")
}

enum AIPlatform {
  MIDJOURNEY
  FLUX
  NANO_BANANA_PRO
  LEONARDO_AI
  DALLE
  STABLE_DIFFUSION
  IDEOGRAM
  PLAYGROUND
  BING_IMAGE_CREATOR
  ADOBE_FIREFLY
  OTHER
}

// ========================================
// Product Mockup Model
// ========================================

model ProductMockup {
  id         String         @id @default(cuid())
  title      String
  mockupUrl  String         @map("mockup_url")
  source     MockupSource
  category   MockupCategory
  notes      String?        @db.Text
  order      Int            @default(0)

  // Relations
  productId String         @map("product_id")
  product   DigitalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  files     ProductFile[]  @relation("MockupFiles")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@map("product_mockups")
}

enum MockupSource {
  PLACEIT
  CANVA
  PHOTOSHOP
  FIGMA
  SMARTMOCKUPS
  MOCKUP_WORLD
  OTHER
}

enum MockupCategory {
  TSHIRT
  MUG
  POSTER
  FRAME
  PHONE_CASE
  TOTE_BAG
  PILLOW
  CANVAS
  BOOK_COVER
  DIGITAL_DEVICE
  OTHER
}

// ========================================
// Product File Model
// ========================================

model ProductFile {
  id             String   @id @default(cuid())
  fileName       String   @map("file_name")
  filePath       String   @map("file_path")
  fileType       FileType @map("file_type")
  fileSize       String?  @map("file_size")
  conceptNotes   String?  @db.Text @map("concept_notes")
  promptRef      String?  @db.Text @map("prompt_ref")
  order          Int      @default(0)

  // Relations
  productId String          @map("product_id")
  product   DigitalProduct  @relation(fields: [productId], references: [id], onDelete: Cascade)
  pictureId String?         @map("picture_id")
  picture   ProductPicture? @relation("PictureFiles", fields: [pictureId], references: [id], onDelete: SetNull)
  mockupId  String?         @map("mockup_id")
  mockup    ProductMockup?  @relation("MockupFiles", fields: [mockupId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([pictureId])
  @@index([mockupId])
  @@map("product_files")
}

enum FileType {
  PSD
  AI
  PNG
  JPG
  SVG
  PDF
  ZIP
  RAR
  EPS
  TIFF
  OTHER
}

// ========================================
// Product Pre-Sale Model
// ========================================

model ProductPreSale {
  id          String       @id @default(cuid())
  stage       PreSaleStage @default(IDEA)
  notes       String?      @db.Text
  checklist   Json?        // Yapılacaklar listesi
  progressLog Json?        // Gelişme günlüğü
  targetDate  DateTime?    @map("target_date")

  // Relations
  productId String         @unique @map("product_id")
  product   DigitalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("product_pre_sales")
}

enum PreSaleStage {
  IDEA
  RESEARCH
  DESIGN
  MOCKUP
  SEO
  READY
}

// ========================================
// Product Sale Info Model (Etsy Listing Data)
// ========================================

model ProductSaleInfo {
  id              String   @id @default(cuid())
  seoTitle        String?  @map("seo_title")
  seoDescription  String?  @db.Text @map("seo_description")
  tags            String[] @default([]) // Etsy 13 tag limit
  category        String?
  subcategory     String?
  pricing         Json?    // Fiyatlandırma bilgileri
  variations      Json?    // Varyasyonlar
  imageOrder      Json?    // Görsel sıralaması
  sku             String?
  stockQuantity   Int?     @default(999) @map("stock_quantity")
  processingTime  String?  @map("processing_time")
  shippingInfo    Json?    @map("shipping_info")
  attributes      Json?    // Ek özellikler
  isDigital       Boolean  @default(true) @map("is_digital")
  renewalOption   String?  @map("renewal_option")
  whoMade         String?  @default("i_did") @map("who_made")
  whenMade        String?  @default("2020_2024") @map("when_made")
  notes           String?  @db.Text

  // Relations
  productId String         @unique @map("product_id")
  product   DigitalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("product_sale_infos")
}
